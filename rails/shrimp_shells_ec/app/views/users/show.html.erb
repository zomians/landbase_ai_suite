<%
  table_head_classes = 'p-3 pb-5'
  table_cells_classes = 'py-5 px-3 leading-none min-w-[150px]'
%>

<div class="wrapper grid-container py-12 space-y-10 md:space-y-14">
  <div class="col-span-full space-y-4">
    <h1 class="font-serif text-h4 md:text-h3"><%= t('spree.my_account') %></h1>
    <div class="flex flex-wrap flex-auto gap-4">
      <%= @user.email %>
      <%= form_with(url: logout_path, method: Devise.sign_out_via, local: true) do %>
        <%= button_tag(t("spree.logout"), class: 'transition-all duration-300 text-black hover:!text-red-500 dark:text-sand underline') %>
      <% end %>
    </div>
  </div>

  <div class="col-span-full grid-container">
    <%= render 'users/users_menu' %>

    <div class="col-span-full md:col-span-10 md:col-start-3 space-y-8">
      
      <!-- é¡§å®¢ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <% if @user.respond_to?(:customer_rank) %>
        <div class="bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-xl border border-amber-200 dark:border-amber-800 p-6">
          <h3 class="text-lg font-bold mb-4 flex items-center">
            <span class="mr-2">ðŸ‘‘</span>
            <%= t('spree.customer_rank') %>
          </h3>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center">
              <div class="text-3xl mb-2"><%= @user.customer_rank_badge %></div>
              <div class="text-sm text-gray-600 dark:text-gray-400"><%= t('spree.current_rank') %></div>
            </div>
            
            <div class="text-center">
              <div class="text-2xl font-bold mb-2"><%= @user.completed_orders.count %></div>
              <div class="text-sm text-gray-600 dark:text-gray-400"><%= t('spree.purchase_count') %></div>
            </div>
            
            <div class="text-center">
              <div class="text-2xl font-bold mb-2">
                <%= Spree::Money.new(@user.completed_orders.sum(:total), currency: Spree::Config[:currency]) %>
              </div>
              <div class="text-sm text-gray-600 dark:text-gray-400"><%= t('spree.total_amount') %></div>
            </div>
            
            <div class="text-center">
              <div class="text-2xl font-bold mb-2">
                <% avg = @user.completed_orders.count > 0 ? @user.completed_orders.sum(:total) / @user.completed_orders.count : 0 %>
                <%= Spree::Money.new(avg, currency: Spree::Config[:currency]) %>
              </div>
              <div class="text-sm text-gray-600 dark:text-gray-400"><%= t('spree.average_amount') %></div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- æ³¨æ–‡å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div>
        <h2 class="font-serif text-h4 md:text-h4 mb-6"><%= I18n.t('spree.my_orders') %></h2>
        
        <% if @orders.present? %>
          <div class="bg-white rounded-xl border border-gray-300 p-6 relative overflow-auto no-scrollbar dark:bg-black dark:border-gray-700">
            <table class="border-collapse w-full table-auto">
              <thead class="border-b border-gray-mid text-left dark:border-gray-400">
                <tr>
                  <th class="<%= table_head_classes %>"><%= I18n.t(:number, scope: 'activerecord.attributes.spree/order') %></th>
                  <th class="<%= table_head_classes %>"><%= I18n.t('spree.date') %></th>
                  <th class="<%= table_head_classes %>"><%= I18n.t('spree.status') %></th>
                  <th class="<%= table_head_classes %>"><%= I18n.t('spree.payment_state') %></th>
                  <th class="<%= table_head_classes %>"><%= I18n.t('spree.shipment_state') %></th>
                  <th class="<%= table_head_classes %>"><%= I18n.t('spree.delivery_info') %></th>
                  <th class="<%= table_head_classes %>"><%= I18n.t('spree.total') %></th>
                  <th class="<%= table_head_classes %>"><%= I18n.t('spree.actions') %></th>
                </tr>
              </thead>
              <tbody class="[&>tr:not(:last-child)]:border-b [&>tr:not(:last-child)]:border-gray-mid">
              <% @orders.each do |order| %>
                <tr>
                  <td class="<%= table_cells_classes %>">
                    <%= link_to order.number, order_url(order), class: 'hover:text-red-500 transition-colors duration-200' %>
                  </td>
                  <td class="<%= table_cells_classes %>"><%= l order.completed_at.to_date %></td>
                  <td class="<%= table_cells_classes %>">
                    <div class="badge badge-<%= I18n.t("spree.order_state.#{order.state}").downcase %>">
                      <%= I18n.t("spree.order_state.#{order.state}").titleize %>
                    </div>
                  </td>
                  <td class="<%= table_cells_classes %>">
                    <%= I18n.t("spree.payment_states.#{order.payment_state}").titleize if order.payment_state %>
                  </td>
                  <td class="<%= table_cells_classes %>">
                    <% if order.shipment_state %>
                      <div class="badge badge-<%= I18n.t("spree.shipment_states.#{order.shipment_state}").downcase %>">
                        <%= I18n.t("spree.shipment_states.#{order.shipment_state}").titleize %>
                      </div>
                    <% end %>
                  </td>
                  <td class="<%= table_cells_classes %>">
                    <% shipment = order.shipments.first %>
                    <% if shipment %>
                      <div class="text-xs space-y-1">
                        <% if shipment.shipped_at %>
                          <div><%= I18n.t('spree.shipped_at') %>: <%= l shipment.shipped_at.to_date %></div>
                        <% end %>
                        <% if shipment.tracking %>
                          <div>
                            <%= link_to I18n.t('spree.track_shipment'), shipment.tracking_url, target: '_blank', class: 'text-blue-600 hover:text-blue-800 underline' %>
                          </div>
                        <% end %>
                      </div>
                    <% end %>
                  </td>
                  <td class="<%= table_cells_classes %>"><%= order.display_total %></td>
                  <td class="<%= table_cells_classes %>">
                    <% if order.completed? %>
                      <button 
                        data-controller="reorder"
                        data-reorder-order-id-value="<%= order.id %>"
                        data-action="click->reorder#confirm"
                        class="text-sm px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                      >
                        <%= I18n.t('spree.reorder') %>
                      </button>
                    <% end %>
                  </td>
                </tr>
              <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p class="rounded-lg bg-black text-white text-center p-4 mt-4 inline-block">
            <%= I18n.t('spree.you_have_no_orders_yet') %>
          </p>
        <% end %>
      </div>
    </div>
  </div>
</div>
