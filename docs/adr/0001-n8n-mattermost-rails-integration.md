# ADR 0001: n8n + Mattermost + Rails 統合アーキテクチャの採用

## ステータス

採用（Accepted）

## 日付

2025-11-13

## コンテキスト（背景・課題）

沖縄県北部の観光業事業者（ホテル、飲食店、ツアー会社など）をワンストップで総合的にサポートする LandBase AI Suite を開発するにあたり、**データドリブン経営を AI ソリューションでサポートする**という課題に直面していた。

### ビジネス要求

- **AnalyticsAI**: 観光業データ分析ダッシュボード

  - 予約・売上・稼働率のリアルタイム可視化
  - マネージメントアカウンティング表の作成
  - 顧客属性・行動分析
  - 競合他社との比較分析
  - AI による将来予測と改善提案

- **OptimaPriceAI**: 需要予測・価格最適化

  - 過去の予約データ、季節変動、イベント情報等を分析
  - リアルタイム価格調整機能
  - 競合他社価格の自動モニタリング

- **ConciergeAI**: AI チャットコンシェルジュ

  - 17 言語対応の自動応答システム
  - 予約確認・変更対応
  - 顧客属性に基づく観光スポット推薦
  - 天候・季節に応じたアクティビティ提案
  - 地域飲食店との連携と予約支援・配達
  - 体験後のフィードバック収集と分析

- **PersonalizeAI**: 顧客分析・CRM

  - 顧客プロファイリングと嗜好や行動パターン分析
  - パーソナライズされた滞在提案
  - リピート率向上のための施策提案
  - リピーター向け特典の自動提案
  - 顧客ロイヤルティプログラム管理

- **ReputationAI**: 口コミ分析・対応支援

  - 複数プラットフォームからの口コミ自動収集
  - 感情分析と重要キーワード抽出
  - 改善ポイントの特定と対策提案
  - 返信文案の自動生成支援
  - ネガティブな評価への対応支援

- **MarketingAI**: マーケティング戦略支援

  - 顧客セグメント分析と最適ターゲティング
  - OTA・自社サイト戦略の最適化
  - SNS マーケティング支援
  - プロモーション効果測定と改善提案

- **OperationAI**: 業務自動化システム

  - スタッフシフト自動調整
  - AI による最適な清掃・メンテナンススケジュール作成
  - 在庫管理・発注自動化
  - 予約情報の自動処理と管理
  - 業務効率分析と改善提案

- **InventoryAI**: スマート在庫管理

  - 消耗品・アメニティの使用量予測
  - 最適発注タイミングと数量の自動算出
  - 在庫コスト最適化
  - サプライヤー比較と調達支援

- **StaffEduAI**: AI スタッフトレーニング
  - カスタマイズ可能なオンライン学習プログラム
  - AI によるサービス品質評価
  - シミュレーションベースのトレーニング
  - スタッフパフォーマンス分析と改善提案

### 技術要件

1. **マルチテナント対応**: 複数の観光業事業者（100+クライアント想定）を 1 つのプラットフォームで管理
2. **ワークフロー自動化**: 複雑な業務プロセスを自動化
3. **チームコミュニケーション**: クライアント毎の独立したコミュニケーション環境
4. **データ管理**: 効率的なデータベース管理と API 提供
5. **OSS（オープンソースソフトウェア）**: コスト効率と柔軟性の確保

### 観光業界の課題

- 人手不足と業務効率化の必要性
- データ活用の遅れ（直感的経営が主流）
- OTA 依存による利益圧迫
- 需給バランスの不均衡

## 検討した選択肢

### 選択肢 1: n8n + Mattermost + Rails（採用）

**構成**:

- **n8n**: ワークフロー自動化エンジン（OSS）
- **Mattermost**: チームコミュニケーション（OSS）
- **Rails**: バックエンド API/管理画面（OSS）
- **PostgreSQL**: 共有データベース（OSS）

**メリット**:

- ✅ すべて OSS（ライセンス費用なし、柔軟なカスタマイズ）
- ✅ **Rails は MVC、CRUD、REST といった基本概念に忠実**（技術的堅実性）
- ✅ **Scaffold 機能による高速開発**（モデル・ビュー・コントローラー・マイグレーションを一括生成）
- ✅ n8n でノーコード/ローコード自動化が可能
- ✅ Mattermost でセキュアなマルチテナントチャット環境
- ✅ 成熟したエコシステムと豊富なドキュメント
- ✅ Docker Compose で統合管理が容易

**デメリット**:

- ⚠️ Rails はマーケティング的には Next.js に劣る
- ⚠️ 複数サービスの連携に初期設定コストがかかる

### 選択肢 2: n8n + Mattermost + Django（不採用）

**構成**:

- **n8n**: ワークフロー自動化エンジン（OSS）
- **Mattermost**: チームコミュニケーション（OSS）
- **Django**: Python バックエンドフレームワーク（OSS）
- **PostgreSQL**: 共有データベース（OSS）

**メリット**:

- ✅ すべて OSS
- ✅ Python エコシステム（AI/ML 統合が容易）
- ✅ Django Admin（強力な管理画面）

**デメリット**:

- ❌ **Scaffold 機能が Rails ほど強力ではない**
- ❌ CRUD 開発の速度が Rails に劣る
- ❌ RESTful API の慣習が Rails ほど確立されていない

**不採用の理由**:

- Rails の scaffold 機能による開発速度が決定的な差
- MVC、CRUD、REST の基本概念への忠実性

### 選択肢 3: Zapier + Slack + Next.js（不採用）

**構成**:

- **Zapier**: ワークフロー自動化（SaaS）
- **Slack**: チームコミュニケーション（SaaS）
- **Next.js**: フロントエンド・バックエンド統合

**メリット**:

- ✅ Next.js はマーケティング的に有利
- ✅ 現代的な開発体験
- ✅ Zapier/Slack のユーザー認知度が高い

**デメリット**:

- ❌ **OSS ではない**（月額コスト発生、スケール時の費用増）
- ❌ Zapier の実行制限・料金体系
- ❌ Slack のマルチテナント管理が複雑
- ❌ カスタマイズ性が限定的

**不採用の理由**:

- OSS 要件を満たさない

## 決定

**n8n + Mattermost + Rails の統合アーキテクチャを採用する**

### 決定の根拠

1. **OSS 要件を満たす**: すべてのコアコンポーネントが OSS
2. **技術的堅実性**: Rails の MVC、CRUD、REST による確立されたアーキテクチャ
3. **開発速度**: Scaffold 機能による高速 CRUD 開発
4. **マルチテナント対応**:
   - n8n: Projects 機能で分離
   - Mattermost: Teams 機能で分離
   - PostgreSQL: 共有 DB + client_code による論理分離
5. **拡張性**: ワークフロー追加、API 拡張が容易
6. **運用コスト**: オンプレミス/クラウドの選択肢、月額費用なし

### 技術スタック詳細

| レイヤー               | 技術           | バージョン | 役割                   |
| ---------------------- | -------------- | ---------- | ---------------------- |
| **ワークフロー自動化** | n8n            | 2.1.1    | OperationAI のコア     |
| **コミュニケーション** | Mattermost     | 9.11       | クライアント別チャット |
| **バックエンド**       | Ruby on Rails  | 8.0+       | API、管理画面          |
| **データベース**       | PostgreSQL     | 16-alpine  | データ永続化           |
| **コンテナ化**         | Docker Compose | -          | 統合環境管理           |

### Next.js の位置付け

**決定**: 当面は Rails を使用し、必要に迫られるまで Next.js は導入しない

**理由**:

- Rails の技術的堅実性を優先
- Next.js のマーケティング上の利点は認識しているが、現時点では不要
- 将来的に必要になった際に、フロントエンドサービスとして追加可能な設計を維持

## 結果

### 実現したアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│              LandBase AI Suite Platform                 │
└─────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐      ┌─────▼──────┐    ┌─────▼──────┐
   │   n8n   │      │ Mattermost │    │ PostgreSQL │
   │(自動化)  │      │ (コミュ)   │    │   (DB)     │
   └────┬────┘      └────────────┘    └─────┬──────┘
        │                                    │
        │           ┌────────────────────────┼─────────┐
        │           │                        │         │
   ┌────▼───────────▼────┐          ┌───────▼────┐ ┌──▼──────────┐
   │ Rails Platform     │          │  Shrimp    │ │  Hotel App  │
   │ (API/管理画面)      │          │  Shells EC │ │  (将来)     │
   │ - OperationAI      │          └────────────┘ └─────────────┘
   │ - MarketingAI      │
   └────────────────────┘
```

### 達成できたこと

1. **マルチテナント SaaS 基盤**: 100+クライアントをサポート可能な設計
2. **ワークフロー自動化**: n8n で清掃スケジュール、在庫管理などを自動化
3. **データドリブン経営**: Rails API でデータ収集・分析基盤を構築
4. **高速開発**: Scaffold による CRUD 機能の即時実装
5. **柔軟な拡張性**: 新しい AI サービスを追加可能
6. **コスト効率**: OSS による低コスト運用

### トレードオフ

- ✅ 技術的堅実性（Rails）を優先
- ✅ 開発速度（Scaffold）を優先
- ⚠️ マーケティング的優位性（Next.js）は将来に先送り
- ⚠️ Python AI/ML エコシステム（Django）は不採用

### 今後の課題

- Next.js 導入のタイミング判断（マーケティング需要が高まった際）
- Rails と Next.js のハイブリッド構成の検討
- フロントエンドサービス（EC、予約サイト）との統合設計

## 参考資料

- [n8n Documentation](https://docs.n8n.io/)
- [Mattermost Documentation](https://docs.mattermost.com/)
- [Ruby on Rails Guides](https://guides.rubyonrails.org/)
- [docs/company-overview.md](../company-overview.md)

## 関連する ADR

- ADR 0002: フロント/バックオフィス分離設計
- ADR 0005: マルチテナント実装戦略
