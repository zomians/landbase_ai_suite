# ADR 0006: Platform基幹アプリ分離

## ステータス

採用（Accepted）

## 日付

2025-12-06

## コンテキスト（背景・課題）

ADR 0002 でフロント/バックオフィス分離アーキテクチャを採用し、バックオフィス（LandBase AI Suite）として単一のRailsアプリケーション構成を想定していた。しかし、プロジェクトの進行に伴い、**バックオフィス内でもさらなる分離が必要**であることが最初から想定されていた。

### 具体的な課題

**issue #53（清掃完了報告AI判定ワークフロー）** と **issue #54（清掃完了判定基準管理サービス）** を実装する際：

- これらは **特定クライアント（Shrimp Shells）専用ではなく、プラットフォーム共通機能**
- hotel業種でも清掃管理は必要（汎用的な機能）
- クライアント固有アプリに実装すると、**他のクライアントで再利用できない**
- プラットフォーム管理機能（クライアント管理、ワークフロー設定等）を配置する場所がない

### ビジネス要件

1. **プラットフォーム共通機能の一元管理**:
   - クライアント管理（CRUD、サービス設定）
   - 清掃基準管理（hotel、宿泊施設向け）
   - 清掃報告管理（AI判定、Mattermost/LINE連携）
   - ワークフロー設定

2. **クライアント固有機能との明確な分離**:
   - クライアント固有アプリ: 業種固有機能
   - Platform: 全業種共通のバックオフィス機能

3. **再利用性**:
   - hotel、tour業種でも清掃管理を利用可能
   - 他の共通機能も同様に再利用

### 技術要件

- マルチテナント対応（client_code分離）
- n8nワークフローとのAPI連携
- Active Storageによる画像管理
- 将来的な管理画面（Rails Admin）

## 検討した選択肢

### 選択肢1: 独立したPlatform Railsアプリ（採用）

**アーキテクチャ**:
```
rails/
└── platform/              # プラットフォーム基幹アプリ
    ├── クライアント管理
    ├── 清掃基準管理 (issue#54)
    ├── 清掃報告管理 (issue#53)
    └── プラットフォームAPI
```

**メリット**:
- ✅ **責務の明確な分離**: プラットフォーム共通 vs クライアント固有
- ✅ **再利用性**: 清掃管理など共通機能を全クライアントで利用可能
- ✅ **独立したデプロイ**: Platform と各クライアントアプリを個別にデプロイ可能
- ✅ **独立したスケーリング**: プラットフォームAPIのみスケール可能
- ✅ **技術スタック一貫性**: 両方Rails 8で統一
- ✅ **ADR 0002との一貫性**: フロント/バックオフィス分離の思想を継承
- ✅ **将来の拡張性**: 新しい共通機能を追加しやすい

**デメリット**:
- ⚠️ Railsアプリが増加（管理コスト若干増）
- ⚠️ 初期構築コスト

### 選択肢2: クライアント固有アプリ内に名前空間で分離（不採用）

**アーキテクチャ**:
```
rails/<client_app>/
├── app/
│   ├── controllers/
│   │   ├── platform/        # プラットフォーム機能
│   │   │   ├── clients_controller.rb
│   │   │   └── cleaning_standards_controller.rb
│   │   └── store/           # EC機能
│   │       └── products_controller.rb
```

**メリット**:
- ✅ 単一Railsアプリ（シンプル）
- ✅ コード共有が容易

**デメリット**:
- ❌ **責務が混在**: フロント固有機能とプラットフォームが同居
- ❌ **再利用困難**: 業種・クライアント横断の再利用が難しい
- ❌ **スケーリング困難**: フロント負荷とプラットフォームAPI負荷を分離できない
- ❌ **ADR 0002の思想に反する**: フロント/バックオフィス分離の原則に矛盾

**不採用の理由**:
- これまでの設計思想（分離、独立性）に合わない

### 選択肢3: Rails Engine（不採用）

**アーキテクチャ**:
```
gems/
└── platform_engine/
    └── プラットフォーム機能をEngineとして実装

rails/<client_app>/
└── Gemfile
    gem 'platform_engine', path: '../gems/platform_engine'
```

**メリット**:
- ✅ 再利用可能なモジュール

**デメリット**:
- ❌ **独立デプロイ不可**: Engineはホストアプリに依存
- ❌ **複雑性**: Engineのマウント、ルーティング統合が複雑
- ❌ **データベース共有**: Engineとホストアプリで同一DB（分離困難）

**不採用の理由**:
- 独立性が不十分

### 選択肢4: マイクロサービス（別言語/フレームワーク）（不採用）

**アーキテクチャ**:
```
platform-api/          # Node.js/Express、Python/FastAPI等
<client_app>/          # Rails
```

**メリット**:
- ✅ 技術スタックの自由度

**デメリット**:
- ❌ **技術スタック分散**: チーム学習コスト増大
- ❌ **ADR 0001に反する**: Rails技術スタックを優先
- ❌ **開発速度低下**: 新しいフレームワーク導入コスト

**不採用の理由**:
- Rails統一という設計原則に反する

## 決定

**独立したPlatform Railsアプリケーションを構築する**

### 決定の根拠

1. **これまでのADRとの一貫性**:
   - **ADR 0002**: フロント/バックオフィス分離の思想を継承
   - **ADR 0001**: Rails技術スタック統一
   - **ADR 0005**: マルチテナント戦略（client_code分離）

2. **責務の明確化**:
   - **Platform**: 全クライアント共通機能
   - **クライアント固有アプリ**: 業種固有機能
   - **Hotel App（将来）**: hotel固有機能

3. **再利用性**:
   - 清掃管理をhotel、宿泊施設でも利用可能
   - 他の共通機能も同様

4. **最初から想定していた設計**:
   - プロジェクト開始時点で、バックオフィス内の分離を計画
   - issue #53, #54で実装のタイミングが来た

### アーキテクチャ設計

#### Platform アプリの責務

**プラットフォーム管理**:
- クライアント管理（CRUD、サービス設定）
- API認証・認可
- マルチテナント管理

**共通業務機能**:
- 清掃基準管理（issue #54）
- 清掃報告管理（issue #53）
- 将来の共通機能（予約管理、在庫管理等）

**API提供**:
- n8nワークフロー連携API
- フロントサービス連携API
- 管理画面API

**管理画面（将来）**:
- Rails Admin導入
- プラットフォーム管理者向けUI

#### クライアント固有アプリの責務（別リポジトリで管理）

- 業種固有のフロント機能
- ストアフロント
- 在庫・配送管理

### 技術スタック

| 項目 | 仕様 |
|------|------|
| **フレームワーク** | Rails 8.0 |
| **データベース** | PostgreSQL（共有、または別DB） |
| **API** | RESTful API |
| **認証** | トークンベース（Bearer） |
| **画像管理** | Active Storage |
| **管理画面** | Rails Admin（将来） |
| **ポート** | 3000 |

### ディレクトリ構成

```
landbase_ai_suite/
├── rails/
│   ├── platform/              # プラットフォーム基幹
│   │   ├── app/
│   │   │   ├── models/
│   │   │   │   ├── client.rb
│   │   │   │   ├── cleaning_standard.rb
│   │   │   │   └── cleaning_session.rb
│   │   │   ├── controllers/
│   │   │   │   └── api/v1/
│   │   │   │       ├── clients_controller.rb
│   │   │   │       ├── cleaning_standards_controller.rb
│   │   │   │       └── cleaning_sessions_controller.rb
│   │   │   ├── services/
│   │   │   │   ├── cleaning_judge_service.rb
│   │   │   │   └── mattermost_notifier_service.rb
│   │   │   └── jobs/
│   │   │       └── cleaning_judge_job.rb
│   │   ├── config/
│   │   │   ├── routes.rb
│   │   │   └── database.yml
│   │   ├── db/
│   │   │   └── migrate/
│   │   ├── spec/
│   │   └── Dockerfile
│   │
│   └── <client_app>/          # 既存: クライアント固有フロント
│       └── ...
│
├── compose.development.yaml   # platformサービス追加
├── Makefile                   # platformコマンド追加
└── .env.development           # PLATFORM_PORT=3000
```

## 結果

### 実現したアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│              LandBase AI Suite Platform                 │
└─────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐      ┌─────▼──────┐    ┌─────▼──────┐
   │   n8n   │      │ Mattermost │    │ PostgreSQL │
   │         │      │            │    │            │
   └────┬────┘      └────────────┘    └─────┬──────┘
        │                                    │
        │           ┌────────────────────────┼─────────┐
        │           │                        │         │
   ┌────▼───────────▼────┐          ┌───────▼────┐ ┌──▼──────────┐
   │ Platform (Rails)   │          │  Client   │ │  Hotel App  │
   │ ポート: 3000        │          │  App      │ │  (将来)     │
   │                    │          │  ポート: - │ │             │
   │ - クライアント管理  │          └────────────┘ └─────────────┘
   │ - 清掃基準管理     │           フロントサービス
   │ - 清掃報告管理     │           (クライアント固有)
   │ - プラットフォームAPI│
   │ - 管理画面         │
   └────────────────────┘
    バックオフィス（共通）
```

### 達成できたこと

1. **明確な責務分離**:
   - Platform: 共通機能（清掃管理、クライアント管理等）
   - クライアントアプリ: 固有機能（EC、予約サイト等）

2. **再利用性**:
   - 清掃管理を全業種で利用可能
   - 他の共通機能も同様

3. **独立性**:
   - 個別デプロイ可能
   - 個別スケーリング可能

4. **一貫性**:
   - これまでのADR（分離、Rails統一、マルチテナント）と一貫

5. **将来の拡張性**:
   - 新しい共通機能を追加しやすい
   - クライアント固有アプリを増やしやすい

### トレードオフ

- ✅ 分離・独立性を優先
- ✅ 再利用性を優先
- ✅ ADRとの一貫性を維持
- ⚠️ Railsアプリ数の増加（2→3以上）
- ⚠️ 初期構築コスト（許容範囲）

### 実装状況（issue #55）

**Phase 1**: Rails 8 アプリ生成（完了）
- `make platform-new`
- Docker設定
- データベース作成

**Phase 2**: 基本設定（計画）
- Gemfile設定（CORS、JWT、画像処理、PDF生成）
- Active Storage
- ルーティング

**Phase 3**: クライアント管理（計画）
- Clientモデル
- API実装

**Phase 4**: 清掃管理（issue #54, #53 / 計画）
- 清掃基準管理
- 清掃報告管理
- AI判定統合

**Phase 5**: Rails Admin（将来）
- 管理画面導入
- 日本語化

## 参考資料

- [issue #55: Platform基幹アプリ構築](https://github.com/zomians/landbase_ai_suite/issues/55)
- [issue #53: 清掃完了報告AI判定ワークフロー](https://github.com/zomians/landbase_ai_suite/issues/53)
- [issue #54: 清掃完了判定基準管理サービス](https://github.com/zomians/landbase_ai_suite/issues/54)
- [ADR 0002: フロント/バックオフィス分離](./0002-frontend-backend-separation.md)

## 関連するADR

- ADR 0001: Rails技術スタック統一（技術基盤）
- ADR 0002: フロント/バックオフィス分離（設計思想）
- ADR 0005: マルチテナント実装戦略（client_code分離）
