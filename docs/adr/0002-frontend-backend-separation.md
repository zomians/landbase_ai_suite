# ADR 0002: フロント/バックオフィス分離アーキテクチャ

## ステータス

採用（Accepted）

## 日付

2025-11-15

## コンテキスト（背景・課題）

ADR 0001 で n8n + Mattermost + Rails の統合アーキテクチャを採用したが、**クライアント毎に Web サイト（フロントサービス）を立ち上げる**というビジネス要件が最初から想定されていた。

### ビジネス要件

1. **クライアント業種別のフロントサービス**:

   - **restaurant**: EC サイト（冷凍食品販売など）
   - **hotel**: 公式予約サイト（直接予約促進）
   - **tour**: ツアー予約サイト（体験プログラム販売）

2. **MarketingAI との緊密な連携**:

   - フロントサイトのアクセス解析データを MarketingAI に送信
   - MarketingAI の分析結果（価格最適化、レコメンド）をフロントサイトに反映
   - A/B テストによるコンバージョン最適化

3. **将来の成長とスケーラビリティ**:
   - クライアントの成長に応じて、別サーバーへの分離を容易にする
   - 各クライアントの独立性を保ちながら、共通基盤を共有

### 技術的課題

- バックオフィス（OperationAI、MarketingAI、など）とフロントサービスを同一アプリケーションにすると：
  - クライアント毎のカスタマイズが困難
  - スケーリング時の分離が複雑
  - フロント変更がバックオフィスに影響を与えるリスク
  - 技術スタックの柔軟性が失われる

## 検討した選択肢

### 選択肢 1: フロント/バックオフィス分離（採用）

**アーキテクチャ**:

```
バックオフィス（共通）:
  - n8n（全クライアント共通）
  - Mattermost（Teams分離）
  - Platform Rails（全クライアント共通、API提供）

フロントサービス（クライアント毎に独立）:
  - restaurant: ECサイト（独立コンテナ）
  - hotel: 予約サイト（独立コンテナ）
  - tour: ツアーサイト（独立コンテナ）
```

**メリット**:

- ✅ クライアント毎のディレクトリ・コンテナ分離で**将来の分離が容易**
- ✅ フロントとバックオフィスの責務が明確
- ✅ 技術スタックの柔軟性（フロントは Next.js、Rails など選択可能）
- ✅ スケーリングの柔軟性（フロントのみ増強可能）
- ✅ MarketingAI との連携が設計しやすい（API 経由のデータ交換）
- ✅ 開発チームの分割が容易（フロント/バックエンド）

**デメリット**:

- ⚠️ 初期の構築コストが増加
- ⚠️ コンテナ数の増加（管理コスト）

### 選択肢 2: モノリシック構成（不採用）

**アーキテクチャ**:

```
単一 Rails アプリケーション:
  - バックオフィス機能
  - 全クライアントのフロントサービス
  - ルーティングでクライアント分離
```

**メリット**:

- ✅ シンプルなデプロイメント
- ✅ コード共有が容易

**デメリット**:

- ❌ クライアント毎のカスタマイズが困難
- ❌ **将来の分離が複雑**（モノリスの分解は困難）
- ❌ スケーリングの柔軟性がない
- ❌ フロント変更がバックオフィスに影響

**不採用の理由**:

- 将来の成長・分離を見据えると、初期から分離しておくべき

### 選択肢 3: マルチテナント単一フロントアプリ（不採用）

**アーキテクチャ**:

```
バックオフィス: 共通
フロント: 単一アプリでサブドメイン分離
  - shrimp-shells.landbase.ai → restaurant向け
  - hotel-example.landbase.ai → hotel向け
```

**メリット**:

- ✅ フロントコードの共有
- ✅ メンテナンスコストの低減

**デメリット**:

- ❌ クライアント毎の完全な独立性がない
- ❌ 業種別の UI/UX 差異に対応しにくい
- ❌ **将来の分離が困難**

**不採用の理由**:

- 業種（restaurant/hotel/tour）で求められるフロント機能が大きく異なる

## 決定

**フロント/バックオフィス分離アーキテクチャを採用する**

### アーキテクチャ設計

#### バックオフィス（LandBase AI Suite - 共通基盤）

**役割**:

- OperationAI: 業務自動化（清掃、在庫、シフト管理）
- MarketingAI: マーケティング分析・戦略支援
- クライアント管理
- API 提供（フロントサービスへデータ提供）
- 統合データ分析

**構成**:

- **n8n**: 全クライアント共通（Projects 機能でテナント分離）
- **Mattermost**: 全クライアント共通（Teams 機能でテナント分離）
- **Platform Rails**: 全クライアント共通（API・管理画面）
- **PostgreSQL**: 共有 DB（client_code で論理分離）

#### フロントサービス（クライアント毎に独立）

**構成**:

```
rails/
├── platform/              # バックオフィス（共通）
└── [client-name]_[type]/  # フロントサービス（独立）
    ├── shrimp_shells_ec/  # restaurant: ECサイト
    ├── hotel_booking/     # hotel: 予約サイト（将来）
    └── tour_experience/   # tour: ツアーサイト（将来）
```

**特徴**:

- **独立したディレクトリ**: クライアント毎に完全分離
- **独立したコンテナ**: Docker Compose で個別管理
- **独立したデータベース**: または共有 DB で論理分離
- **API 経由連携**: Platform Rails API を通じてバックオフィスと連携

### MarketingAI 連携設計

```
┌────────────────────────────────────────┐
│         フロントサービス                 │
│   (ECサイト/予約サイト)                  │
└────────────┬───────────────────────────┘
             │
             │ 1. アクセス解析データ送信
             │    (PV, CV, ユーザー行動)
             ↓
┌────────────────────────────────────────┐
│      Platform Rails (バックオフィス)   │
│  ┌──────────────────────────────────┐  │
│  │       MarketingAI               │  │
│  │  - データ分析                    │  │
│  │  - 価格最適化                    │  │
│  │  - レコメンド生成                │  │
│  │  - A/Bテスト結果分析             │  │
│  └──────────────────────────────────┘  │
└────────────┬───────────────────────────┘
             │
             │ 2. 最適化結果返信
             │    (推奨価格, レコメンド商品)
             ↓
┌────────────────────────────────────────┐
│         フロントサービス               │
│   - 価格を動的更新                     │
│   - レコメンド表示                     │
│   - A/Bテストバリアント適用            │
└────────────────────────────────────────┘
```

### 将来の分離戦略

**Phase 1**: 初期（現在）

- 全フロントサービスは同一サーバー・Docker Compose 環境

**Phase 2**: 成長期

- トラフィック増加したクライアントのフロントを別サーバーに移行
- ディレクトリ・コンテナ独立のため、移行が容易
- API 接続先 URL を変更するだけ

**Phase 3**: 大規模化

- クライアント毎に完全独立したインフラ
- バックオフィス API のみ共有

## 結果

### 実現したアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│              LandBase AI Suite Platform                 │
│                 (バックオフィス - 共通)                  │
│                                                         │
│  ┌─────────┐  ┌────────────┐  ┌──────────────────┐    │
│  │   n8n   │  │ Mattermost │  │ Platform Rails   │    │
│  │(共通)   │  │ (Teams分離)│  │ (API/管理/AI)    │    │
│  └─────────┘  └────────────┘  └──────────────────┘    │
│                                        │                │
└────────────────────────────────────────┼────────────────┘
                                         │ API
                 ┌───────────────────────┼───────────────┐
                 │                       │               │
        ┌────────▼────────┐    ┌────────▼────────┐  ┌──▼──────┐
        │ Shrimp Shells   │    │ Hotel Booking   │  │  Tour   │
        │ EC (restaurant) │    │ (hotel)         │  │ (tour)  │
        │                 │    │                 │  │         │
        │ - 独立コンテナ   │    │ - 独立コンテナ   │  │ - 独立  │
        │ - 独立ディレクトリ│   │ - 独立ディレクトリ│ │   コンテナ│
        └─────────────────┘    └─────────────────┘  └─────────┘
         フロントサービス       フロントサービス     フロントサービス
         (クライアント毎に独立)
```

### 達成できたこと

1. **明確な責務分離**:

   - バックオフィス: AI、自動化、データ分析
   - フロント: 顧客対応 UI、予約・販売

2. **MarketingAI 連携の最適化**:

   - API 経由のリアルタイムデータ交換
   - 価格最適化の即時反映
   - A/B テストの柔軟な実施

3. **将来の分離可能性**:

   - ディレクトリ・コンテナレベルの独立性
   - 成長に応じた段階的な分離が容易

4. **技術スタックの柔軟性**:

   - フロントは業種に応じて最適な技術選択可能
   - バックオフィスは安定した Rails

5. **スケーラビリティ**:
   - クライアント毎に独立してスケール可能
   - バックオフィスとフロントを個別に最適化

### トレードオフ

- ✅ 将来の分離可能性を優先
- ✅ MarketingAI 連携の最適化
- ⚠️ 初期の構築コスト増加（許容範囲）
- ⚠️ コンテナ管理の複雑性増加（Docker Compose で管理）

### 今後の展開

1. **Phase 1** (2025): Shrimp Shells EC 実装
2. **Phase 2** (2026): Hotel 予約サイト実装
3. **Phase 3** (2026): Tour サイト実装
4. **Phase 4** (成長期): 必要に応じて個別サーバーへ分離

## 参考資料

- [ADR 0001: n8n + Mattermost + Rails 統合アーキテクチャ](./0001-n8n-mattermost-rails-integration.md)
- [Microservices Pattern](https://microservices.io/)
- [docs/business/company-overview.md](../business/company-overview.md)

## 関連する ADR

- ADR 0001: n8n + Mattermost + Rails 統合アーキテクチャ（前提）
- ADR 0003: restaurant EC サイトに Solidus を採用（フロントサービスの実装例）
- ADR 0006: Platform 基幹アプリ分離（バックオフィス内の更なる分離）
