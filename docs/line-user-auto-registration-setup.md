# LINE ユーザー自動登録機能 セットアップガイド

## 📋 概要

LINE友だち追加だけで、自動的に`Master_User_Config`に登録される機能です。

### 仕組み

```
ユーザー: LINE友だち追加
    ↓
n8n: Follow Event受信 → userIdを取得
    ↓
Master_User_Configに追加（customer_name: "未設定"）
    ↓
LINE: ウェルカムメッセージ送信
    ↓
管理者: スプレッドシートで顧客情報を設定
```

---

## 🚀 セットアップ手順

### Step 1: Master_User_Configに列を追加

既存のスプレッドシートに `F列: registration_date` を追加します（オプション）。

**更新後のスキーマ:**

| A: line_user_id | B: customer_name | C: drive_folder_id | D: sheet_id | E: accounting_soft | F: registration_date |
|---|---|---|---|---|---|
| Uxxx... | 未設定 | | | freee | 2025-12-19T10:30:00 |

### Step 2: n8nワークフローのインポート

1. n8n管理画面にアクセス: `http://localhost:5678`
2. 左メニューから「Workflows」を選択
3. 右上の「Import from File」をクリック
4. `n8n/workflows/line-user-auto-registration.json` を選択
5. インポート完了

### Step 3: ワークフロー設定の編集

#### 3-1. 「既存ユーザー確認」ノード

- **Document ID**: Master_User_ConfigスプレッドシートのID
- **Sheet Name**: `Master_User_Config`
- **Credential**: `gsheet-oauth`

#### 3-2. 「新規ユーザー登録」ノード

- **Document ID**: 同じMaster_User_ConfigスプレッドシートのID
- **Sheet Name**: `Master_User_Config`
- **Credential**: `gsheet-oauth`

### Step 4: Webhook URLの確認

**重要:** 既存の領収書処理ワークフローと同じWebhook URL (`line-webhook`) を使用します。

- 既存ワークフロー: `events[0].type = "message"` をフィルタ
- 新ワークフロー: `events[0].type = "follow"` をフィルタ

**競合しないため、LINE Developers側の設定変更は不要です。**

### Step 5: ワークフローの有効化

1. ワークフロー画面右上の「Active」トグルを **ON** に設定
2. 「Save」をクリック

---

## 💡 使い方

### ユーザー側の操作

1. LINE公式アカウントを友だち追加
2. 自動的にウェルカムメッセージが届く
3. 管理者からの連絡を待つ

**ウェルカムメッセージの内容:**
```
✅ 友だち追加ありがとうございます！

登録が完了しました。
管理者が設定を完了次第、領収書画像を送信できるようになります。

LINE User ID:
Uxxx...
```

### 管理者側の操作

1. 新規友だち追加を確認（LINEアプリの通知で分かる）
2. Master_User_Configスプレッドシートを開く
3. `customer_name: "未設定"` の行を探す
4. 以下の情報を設定：
   - **B列（customer_name）**: 顧客名を入力
   - **C列（drive_folder_id）**: Google DriveフォルダのIDを入力
   - **D列（sheet_id）**: 仕訳台帳スプレッドシートのIDを入力
   - **E列（accounting_soft）**: `freee` または `moneyforward`（デフォルトはfreee）
5. 保存
6. ユーザーに「設定完了しました。領収書を送信してください」と連絡

---

## 🔄 運用フロー

```
┌────────────────────────────────────────────┐
│  1. ユーザーがLINE友だち追加               │
└─────────────┬──────────────────────────────┘
              │
              ▼
┌────────────────────────────────────────────┐
│  2. n8n: Follow Event受信                  │
│     - userId取得                           │
│     - 既存チェック                          │
└─────────────┬──────────────────────────────┘
              │
              ▼
┌────────────────────────────────────────────┐
│  3. Master_User_Configに自動追加           │
│     - line_user_id: 取得したID             │
│     - customer_name: "未設定"              │
│     - その他: 空欄                          │
└─────────────┬──────────────────────────────┘
              │
              ▼
┌────────────────────────────────────────────┐
│  4. LINEウェルカムメッセージ送信           │
└─────────────┬──────────────────────────────┘
              │
              ▼
┌────────────────────────────────────────────┐
│  5. 管理者がスプレッドシートで設定         │
│     - 顧客名                                │
│     - DriveフォルダID                       │
│     - 仕訳台帳シートID                      │
└─────────────┬──────────────────────────────┘
              │
              ▼
┌────────────────────────────────────────────┐
│  6. ユーザーに連絡                         │
│     「設定完了。領収書を送信可能です」     │
└────────────────────────────────────────────┘
```

---

## ⚙️ デフォルト設定値

新規ユーザー登録時のデフォルト値：

| 列名 | デフォルト値 | 説明 |
|---|---|---|
| line_user_id | 自動取得 | LINEから自動取得 |
| customer_name | "未設定" | 管理者が後で設定 |
| drive_folder_id | 空欄 | 管理者が後で設定 |
| sheet_id | 空欄 | 管理者が後で設定 |
| accounting_soft | "freee" | デフォルトはfreee |
| registration_date | 現在時刻 | 登録日時（自動） |

---

## 🐛 トラブルシューティング

### 問題1: 友だち追加してもウェルカムメッセージが届かない

**原因:** ワークフローがActiveになっていない、またはWebhook URLが正しくない

**解決策:**
1. n8nでワークフローが「Active」になっているか確認
2. LINE DevelopersのWebhook URLが正しいか確認（既存ワークフローと同じURL）
3. ngrokが起動しているか確認（開発環境の場合）
4. n8nの実行ログ（Executions）でエラーを確認

### 問題2: ウェルカムメッセージは届いたが、スプレッドシートに追加されていない

**原因:** Google Sheets Credentialの権限不足、またはシートIDが間違っている

**解決策:**
1. n8nの実行ログ（Executions）でエラーを確認
2. `gsheet-oauth`の権限を再確認（書き込み権限必要）
3. Master_User_ConfigスプレッドシートのIDを確認
4. シート名が完全一致で `Master_User_Config` になっているか確認

### 問題3: 既に登録済みのユーザーが再度追加される

**原因:** 「既存ユーザー確認」ノードのフィルター設定が間違っている

**解決策:**
1. 「既存ユーザー確認」ノードの設定を確認
2. Lookup Column が `line_user_id` になっているか確認
3. Lookup Value が正しいExpression (`={{ $json.body.events[0].source.userId }}`) か確認

### 問題4: 既存の領収書処理ワークフローが動かなくなった

**原因:** Webhook URLの競合（可能性は低い）

**解決策:**
1. 既存ワークフローのIFノードで `message.type = "image"` のフィルタが正しいか確認
2. 新規ワークフローのIFノードで `events[0].type = "follow"` のフィルタが正しいか確認
3. 両ワークフローが「Active」になっているか確認

---

## ✅ メリット

- ✅ 実装がシンプル（ワークフロー1つ）
- ✅ ユーザーは友だち追加するだけ
- ✅ 追加の画面・システム不要
- ✅ 既存ワークフローとの統合が簡単
- ✅ メンテナンスコストほぼゼロ

## ⚠️ デメリットと対策

### デメリット1: 誰でも登録できる

**対策:** 
- 後から削除可能（スプレッドシートの行を削除）
- LINE公式アカウントの友だち追加設定を制限
- 定期的にスプレッドシートを確認

### デメリット2: 管理者への通知なし

**対策（今後の改善）:**
- Slackやメールで通知機能を追加
- 定期的に「未設定」ユーザーをチェックするスクリプト

---

## 📈 今後の改善案

### Phase 1: 管理者通知の追加

新規登録時にSlackやメールで通知：

```json
{
  "name": "Slack通知",
  "type": "n8n-nodes-base.slack",
  "parameters": {
    "channel": "#経理bot通知",
    "text": "新規ユーザーが登録されました\\nLINE ID: {{ $('Webhook').item.json.body.events[0].source.userId }}"
  }
}
```

### Phase 2: 自動リソース作成

登録時に自動的にGoogle DriveフォルダとSpreadsheetを作成し、IDを自動設定。

### Phase 3: 対話式登録

友だち追加後、ボットが「会社名を教えてください」と質問し、`customer_name`を自動入力。

---

## テスト方法

### 1. 基本動作テスト

1. 別のLINEアカウントで友だち追加
2. ウェルカムメッセージが届くことを確認
3. Master_User_Configに行が追加されていることを確認
4. `customer_name`が「未設定」になっていることを確認

### 2. 二重登録防止テスト

1. 同じLINEアカウントで一旦ブロック
2. 再度友だち追加
3. 「既に登録済みです」メッセージが届くことを確認
4. Master_User_Configに重複行がないことを確認

### 3. 既存ワークフローとの共存テスト

1. 領収書画像を送信
2. 既存の処理フローが正常に動作することを確認
3. Follow Eventと競合していないことを確認

---

## ライセンス

All rights reserved. © 株式会社 AI.LandBase
